<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <script type="text/javascript" src="../lib/jquery.min.js"></script>
    <script type="text/javascript" src="../lib/osql.js"></script>
    <script>
        osql.requireLogin();

        $(document).ready(function () {
            id2();
        });


        async function id2() {
            var me = await osql.getMe();
            console.log(me);

            var gameid = sessionStorage.getItem('gameid');
            var turn2 = sessionStorage.getItem('turn2');

            var id = me.id;
            var name = me.fname + ' ' + me.lname;
            var sql = `insert ignore into Players values('${id}', '${name}')`;
            var objects = await osql.connect(sql);



            document.getElementById('turn1').innerHTML = name + 'さんの番です';
        }



        async function runButtonPressed() {

            var me = await osql.getMe();
            console.log(me);

            var gameid = sessionStorage.getItem('gameid');
            var turn2 = sessionStorage.getItem('turn2');
            var turn3 = Number(turn2);

            var gameid = 1//sessionStorage.getItem('gameid');
            var playerid = me.id
            var turnid = 1//sessionStorage.getItem('turnid');
            var content = document.getElementById('tf2').value;
            var sql = `insert into Items (gameid, playerid, turn, content) values (${gameid}, "${playerid}", ${turn3}, "${content}");`;
            var objects = await osql.connect(sql);

            //テーブルを表示させる
            var sql2 = `select * from Items`;
            var objects2 = await osql.connect(sql2);
            var html = '';
            html = html + '<table border = "1">';
            html = html + '<tr>';
            html = html + '<td>' + 'playerid' + '</td>';
            html = html + '<td>' + 'turn' + '</td>';
            html = html + '<td>' + 'content' + '</td>';
            html = html + '</tr>';
            for (var i = 0; i < objects2.length; i++) {
                var object2 = objects2[i];
                html = html + '<tr>';
                html = html + '<td>' + object2.playerid + '</td>';
                html = html + '<td>' + object2.turn + '</td>';
                html = html + '<td>' + object2.content + '</td>';
                html = html + '</tr>';
            }
            html = html + '</table>';
            document.getElementById('result').innerHTML = html;

            var sql3 = `select * from G_P`;
            var objects3 = await osql.connect(sql3);
            var object3 = objects3[objects3.length - 1];  // リストの一番下の行を表示
            var orderid = object3.orderid;
            var orderid2 = Number(orderid) + 1;



            if (((turn3 - 1) % orderid2 + 1) == orderid2) {
                document.getElementById("show").style.display = "block";
                document.getElementById("tf2").style.display = "block";
            } else {
                document.getElementById("show").style.display = "none";
                document.getElementById("tf2").style.display = "none";
                document.getElementById('show2').innerHTML = ("待っててね！")
            }

        }
    </script>
</head>

<body>
    <p id="turn1"></p>
    <input id="tf2" type="textfield">
    <button id="show" onclick="runButtonPressed()">入力</button>
    <p id=show2></p>
    <p id='result'></p>
</body>

</html>