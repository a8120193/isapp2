<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <script type="text/javascript" src="../lib/jquery.min.js"></script>
    <script type="text/javascript" src="../lib/osql.js"></script>
    <script>
        osql.requireLogin();

        $(document).ready(function () {
            id2();
            // setInterval(id2, 2000);
        });

        async function id2() {
            var me = await osql.getMe();
            console.log(me);


            var themename = osql.getParam('name');

            var sql3 = `select * from Theme where name = "${themename}"`;
            var objects3 = await osql.connect(sql3);
            var themeid = objects3[0].id;

            var id = me.id;
            var name = me.fname + ' ' + me.lname;
            var sql = `insert ignore into Users values('${id}', '${name}')`;
            var objects = await osql.connect(sql);

            document.getElementById('welcome').innerHTML = 'テーマ「' + themename + '」';

            var sql2 = `select * from Items where themeid = ${themeid}`;
            var objects2 = await osql.connect(sql2);

            var sql3 = `select * from Groups`;
            var objects3 = await osql.connect(sql3);

            var sql4 = `select * from Items inner join I_G on Items.id = I_G.itemid`; //グループごとのテーブルを検索する文
            var objects4 = await osql.connect(sql4);

            グループごとにテーブル表示する
            for (var k = 0; k < objects3.length; k++) {
                var object3 = objects3[k];
                var html = '';
                html = html + '<h1>' + object3.title + '</h1>';
                html = html + '<table border = "1">';
                html = html + '<tr>';
                html = html + '<td>' + 'グループ' + '</td>';
                html = html + '<td>' + '投稿者名' + '</td>';
                html = html + '<td>' + '入力時間' + '</td>';
                html = html + '<td>' + '意見' + '</td>';
                html = html + '</tr>';
                for (var i = 0; i < objects2.length; i++) {
                    var object2 = objects2[i];
                    html = html + '<tr>';
                    html = html + '<td><select>'
                    for (var j = 0; j < objects3.length; j++) {
                        var object33 = objects3[j];
                        html = html + '<option>' + object33.title + '</option>'
                    }
                    html = html + '</select></td>';
                    html = html + '<td>' + object2.userid + '</td>'; //sql4作ったらobjectを変える。グループごとのテーブル表示。
                    html = html + '<td>' + object2.time + '</td>';
                    html = html + '<td>' + object2.content + '</td>';
                    html = html + '</tr>';
                }
                html = html + '</table>';
                document.getElementById('result').innerHTML = html;
            }





            var html = '';
            html = html + '<h1>未設定</h1>';
            html = html + '<table border = "1">';
            html = html + '<tr>';
            html = html + '<td>' + 'グループ' + '</td>';
            html = html + '<td>' + '投稿者名' + '</td>';
            html = html + '<td>' + '入力時間' + '</td>';
            html = html + '<td>' + '意見' + '</td>';
            html = html + '</tr>';
            for (var i = 0; i < objects2.length; i++) {
                var object2 = objects2[i];
                html = html + '<tr>';
                html = html + '<td><select id = ' + themeid + '>'
                for (var j = 0; j < objects3.length; j++) {
                    var object3 = objects3[j];
                    html = html + '<option id =' + object3.id + '>' + object3.title + '</option>'
                }
                html = html + '</select></td>';
                html = html + '<td>' + object2.userid + '</td>';
                html = html + '<td>' + object2.time + '</td>';
                html = html + '<td>' + object2.content + '</td>';
                html = html + '</tr>';
            }
            html = html + '</table>';
            document.getElementById('result').innerHTML = html;
        };



        async function runButtonPressed() {
            var me = await osql.getMe();
            console.log(me);

            id2();

            var themename = osql.getParam('name');
            var sql3 = `select * from Theme where name = "${themename}"`;
            var objects3 = await osql.connect(sql3);
            var themeid = objects3[0].id;

            var content = document.getElementById('tf2').value;
            var userid = me.fname + ' ' + me.lname;
            var sql = `insert into Items (userid, content, themeid) values ("${userid}", "${content}", "${themeid}")`;
            var objects = await osql.connect(sql);
            tf2.value = '';
        }

        async function runButtonPressed_group() {


            var me = await osql.getMe();
            console.log(me);

            id2();

            var title = document.getElementById('tf3').value;
            var sql4 = `insert into Groups (title) values ("${title}")`;
            var objects4 = await osql.connect(sql4);


            // var sql5 = `select * from Groups where title = "${title}"`
            // var objects5 = await osql.connect(sql5);
            // var groupid = objects5[0].id;

            // var sql6 = `insert into I_G (Groupid, itemid) values ("${groupid}", "${}")`
            // var objects6 = await osql.connect(sql6);

            tf3.value = '';

        }

        async function runButtonPressed_henkou() {
            //プルで選択した後押す確定ボタン。グループのidと意見のidを結びつけたい。sql変えればいい？
        }


    </script>
</head>

<body>
    <h1 id="welcome"> </h1>
    意見
    <br>
    <input id="tf2" type="textfield">
    <button onclick="runButtonPressed()">入力</button>
    <br>
    グループ名
    <br>
    <input id="tf3" type="textfield">
    <button id="group" onclick="runButtonPressed_group()">作成</button>
    <br>
    <button id="henkou" onclick="runButtonPressed_henkou()">グループ変更</button>
    <p id='result'></p>
</body>

</html>